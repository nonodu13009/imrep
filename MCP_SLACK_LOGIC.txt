================================================================================
  LOGIQUE MCP (MODEL CONTEXT PROTOCOL) AVEC SLACK - EXPLICATION TECHNIQUE
================================================================================

üìã VUE D'ENSEMBLE
================================================================================

Ce document explique comment fonctionne l'int√©gration des notifications Slack
dans l'application IMREP/Allianz, et pourquoi nous utilisons (ou n'utilisons pas)
le protocole MCP dans l'impl√©mentation actuelle.

--------------------------------------------------------------------------------

üéØ QU'EST-CE QUE MCP (MODEL CONTEXT PROTOCOL) ?
================================================================================

MCP (Model Context Protocol) est un protocole standardis√© qui permet √† des
applications (comme Cursor, Claude Desktop, etc.) de communiquer avec des
serveurs externes via JSON-RPC 2.0.

Avantages de MCP :
- Standardisation de la communication
- S√©paration des responsabilit√©s
- R√©utilisabilit√© entre diff√©rentes applications
- Support natif dans certains outils IA

Dans notre cas, MCP pourrait √™tre utilis√© pour cr√©er un serveur externe qui
g√®re les notifications Slack, mais nous avons choisi une approche plus simple
et directe pour ce projet.

--------------------------------------------------------------------------------

üèóÔ∏è ARCHITECTURE ACTUELLE (IMPL√âMENTATION SIMPLIFI√âE)
================================================================================

Au lieu d'utiliser un serveur MCP s√©par√©, nous utilisons une approche directe
avec des routes API Next.js et des webhooks Slack.

FLUX DE DONN√âES :

‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Action utilisateur ‚îÇ  (ex: cr√©ation de lot, validation, etc.)
‚îÇ  dans l'application ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Server Action ou   ‚îÇ  (lib/lots/actions.ts, lib/firebase/admin-actions.ts)
‚îÇ  API Route Next.js  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ Appelle sendSlackNotification()
           ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  lib/slack.ts       ‚îÇ  Module centralis√© de notifications Slack
‚îÇ                     ‚îÇ  - V√©rifie SLACK_ENABLED
‚îÇ                     ‚îÇ  - R√©cup√®re SLACK_WEBHOOK_URL
‚îÇ                     ‚îÇ  - Envoie le message
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ
           ‚îÇ Deux chemins possibles :
           ‚îÇ
           ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚îÇ                                 ‚îÇ
           ‚ñº                                 ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Envoi direct       ‚îÇ         ‚îÇ  Via API Route      ‚îÇ
‚îÇ  (si variables      ‚îÇ         ‚îÇ  /api/slack/notify  ‚îÇ
‚îÇ   d'env disponibles)‚îÇ         ‚îÇ  (fallback si       ‚îÇ
‚îÇ                     ‚îÇ         ‚îÇ   variables non     ‚îÇ
‚îÇ  fetch(webhookUrl)  ‚îÇ         ‚îÇ   disponibles)      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
           ‚îÇ                               ‚îÇ
           ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ  Slack Webhook      ‚îÇ  (Incoming Webhook)
                ‚îÇ  https://hooks.     ‚îÇ
                ‚îÇ  slack.com/...      ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                           ‚îÇ
                           ‚ñº
                ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                ‚îÇ  Canal Slack         ‚îÇ  (Notifications re√ßues)
                ‚îÇ  #notifications      ‚îÇ
                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

--------------------------------------------------------------------------------

üîß TECHNOLOGIES UTILIS√âES
================================================================================

1. NEXT.JS (Framework React)
   - Routes API : app/api/slack/notify/route.ts
   - Server Actions : pour les op√©rations c√¥t√© serveur
   - Variables d'environnement : gestion s√©curis√©e des secrets

2. FIREBASE
   - Firestore : base de donn√©es NoSQL
   - Firebase Auth : authentification des utilisateurs
   - Firebase Admin SDK : op√©rations administratives c√¥t√© serveur

3. SLACK API
   - Incoming Webhooks : m√©thode simple pour envoyer des messages
   - Pas besoin d'OAuth ou de tokens complexes
   - URL webhook unique par canal

4. TYPESCRIPT
   - Typage fort pour la s√©curit√© du code
   - Meilleure maintenabilit√©

5. NODE.JS / FETCH API
   - Requ√™tes HTTP pour communiquer avec Slack
   - Support natif dans Next.js (pas besoin de biblioth√®que externe)

--------------------------------------------------------------------------------

üìÅ STRUCTURE DES FICHIERS
================================================================================

lib/slack.ts
  ‚îî‚îÄ Module centralis√© pour toutes les notifications Slack
     ‚îú‚îÄ sendSlackNotification() : Envoi simple avec texte
     ‚îú‚îÄ sendSlackEvent() : Envoi format√© avec titre + d√©tails
     ‚îî‚îÄ Gestion automatique du fallback (direct ‚Üí API route)

app/api/slack/notify/route.ts
  ‚îî‚îÄ Route API Next.js qui sert de proxy
     ‚îî‚îÄ Utilise les variables d'environnement c√¥t√© serveur
        (n√©cessaire car les variables ne sont pas toujours disponibles c√¥t√© client)

lib/lots/actions.ts
  ‚îî‚îÄ Actions m√©tier pour les lots
     ‚îî‚îÄ Appelle sendSlackNotification() apr√®s chaque action importante

lib/firebase/admin-actions.ts
  ‚îî‚îÄ Actions administratives (cr√©ation utilisateur, etc.)
     ‚îî‚îÄ Appelle sendSlackNotification() pour notifier les √©v√©nements admin

--------------------------------------------------------------------------------

üîê VARIABLES D'ENVIRONNEMENT
================================================================================

Variables requises dans .env.local (d√©veloppement) ou Vercel (production) :

SLACK_ENABLED=true
  ‚îî‚îÄ Active/d√©sactive les notifications Slack
     (utile pour d√©sactiver en d√©veloppement local)

SLACK_WEBHOOK_URL=https://hooks.slack.com/services/...
  ‚îî‚îÄ URL du webhook Slack Incoming
     (obtenue depuis api.slack.com/apps ‚Üí Incoming Webhooks)

NEXT_PUBLIC_APP_URL=https://imrep-nu.vercel.app
  ‚îî‚îÄ URL de l'application (pour le fallback via API route)

--------------------------------------------------------------------------------

üîÑ LOGIQUE DE FONCTIONNEMENT
================================================================================

1. D√âTECTION DU CONTEXTE
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Quand sendSlackNotification() est appel√©e :
   
   a) Si SLACK_ENABLED !== "true"
      ‚Üí Retourne false imm√©diatement (Slack d√©sactiv√©)
   
   b) Si SLACK_WEBHOOK_URL est disponible dans process.env
      ‚Üí Envoi DIRECT au webhook Slack
      ‚Üí Plus rapide, moins de latence
   
   c) Si SLACK_WEBHOOK_URL n'est pas disponible (c√¥t√© client)
      ‚Üí Fallback : appel √† l'API route /api/slack/notify
      ‚Üí L'API route a acc√®s aux variables d'environnement
      ‚Üí L'API route fait l'envoi au webhook

2. GESTION DES ERREURS
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   - Les erreurs Slack ne doivent JAMAIS faire √©chouer l'action principale
   - Logging des erreurs pour le debugging
   - Retour silencieux (false) en cas d'√©chec
   - L'utilisateur ne voit pas d'erreur si Slack √©choue

3. FORMAT DES MESSAGES
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   Format simple : { "text": "Message √† envoyer" }
   
   Format enrichi (sendSlackEvent) :
   ```
   Titre du message
   ‚Ä¢ D√©tail 1: Valeur 1
   ‚Ä¢ D√©tail 2: Valeur 2
   ‚Ä¢ D√©tail 3: Valeur 3
   ```

--------------------------------------------------------------------------------

üöÄ POURQUOI PAS DE SERVEUR MCP S√âPAR√â ?
================================================================================

Dans la documentation docs/mcp.md, il y a une explication sur comment cr√©er
un serveur MCP s√©par√©, mais nous avons choisi de ne PAS l'utiliser pour :

1. SIMPLICIT√â
   - Pas besoin de maintenir un serveur Node.js s√©par√©
   - Tout est int√©gr√© dans Next.js
   - Moins de points de d√©faillance

2. D√âPLOIEMENT
   - Next.js d√©ploy√© sur Vercel g√®re tout
   - Pas besoin de d√©ployer un serveur MCP s√©par√©
   - Moins de co√ªts d'infrastructure

3. PERFORMANCE
   - Appels directs plus rapides
   - Pas de latence r√©seau suppl√©mentaire
   - Moins de complexit√© r√©seau

4. MAINTENABILIT√â
   - Code centralis√© dans le m√™me projet
   - Plus facile √† d√©boguer
   - Moins de d√©pendances externes

--------------------------------------------------------------------------------

üìä EXEMPLES D'UTILISATION
================================================================================

1. NOTIFICATION SIMPLE
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   import { sendSlackNotification } from "@/lib/slack";
   
   await sendSlackNotification("üè† Nouveau lot cr√©√© : 123 Rue de la Paix");

2. NOTIFICATION FORMAT√âE
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   import { sendSlackEvent } from "@/lib/slack";
   
   await sendSlackEvent("‚úÖ Lot valid√©", {
     "Adresse": "123 Rue de la Paix",
     "Num√©ro de contrat": "CTR-2025-001",
     "Valid√© par": "jeanmichel@allianz-nogaro.fr",
     "Date": new Date()
   });

3. DANS UNE ACTION M√âTIER
   ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   export async function createLot(lotData, userId) {
     // ... cr√©ation du lot dans Firestore ...
     
     // Notification Slack (non-bloquant)
     sendSlackNotification(
       `üè† Nouveau lot cr√©√©\n` +
       `‚Ä¢ Adresse: ${lotData.adresse}\n` +
       `‚Ä¢ Cr√©√© par: ${userId}`
     ).catch(err => console.error("Erreur Slack:", err));
     
     return lotId;
   }

--------------------------------------------------------------------------------

üîç POINTS D'INT√âGRATION ACTUELS
================================================================================

Les notifications Slack sont envoy√©es lors de :

ACTIONS IMREP :
- ‚úÖ Cr√©ation d'un lot
- ‚úÖ Modification d'un lot
- ‚úÖ Demande de sortie
- ‚úÖ Demande de suppression

ACTIONS ALLIANZ :
- ‚úÖ Validation d'entr√©e
- ‚úÖ Refus d'entr√©e
- ‚úÖ Validation de sortie
- ‚úÖ Refus de sortie
- ‚úÖ Validation de suppression
- ‚úÖ Refus de suppression
- ‚úÖ Cr√©ation d'utilisateur

--------------------------------------------------------------------------------

üõ†Ô∏è COMMENT AJOUTER UNE NOUVELLE NOTIFICATION
================================================================================

1. Identifier l'action m√©tier qui doit d√©clencher la notification
   (ex: dans lib/lots/actions.ts ou lib/firebase/admin-actions.ts)

2. Importer la fonction :
   import { sendSlackNotification } from "@/lib/slack";

3. Appeler apr√®s l'action r√©ussie :
   await sendSlackNotification("Votre message ici");

4. G√©rer les erreurs (optionnel, mais recommand√©) :
   sendSlackNotification("Message").catch(err => 
     console.error("Erreur Slack:", err)
   );

5. Tester en d√©veloppement local avec SLACK_ENABLED=true

--------------------------------------------------------------------------------

üìù NOTES IMPORTANTES
================================================================================

‚ö†Ô∏è S√âCURIT√â
- Ne JAMAIS commiter SLACK_WEBHOOK_URL dans le code
- Utiliser TOUJOURS des variables d'environnement
- Le webhook URL est un secret, le prot√©ger comme tel

‚ö†Ô∏è PERFORMANCE
- Les appels Slack sont asynchrones et non-bloquants
- Ne pas attendre la r√©ponse Slack pour continuer l'action principale
- Utiliser .catch() pour √©viter que les erreurs Slack bloquent le flux

‚ö†Ô∏è D√âVELOPPEMENT
- D√©sactiver Slack en d√©veloppement local si besoin (SLACK_ENABLED=false)
- Tester avec un canal Slack d√©di√© au d√©veloppement
- V√©rifier les logs Vercel en production pour les erreurs

‚ö†Ô∏è PRODUCTION
- V√©rifier que SLACK_WEBHOOK_URL est bien configur√© dans Vercel
- Surveiller les erreurs dans les logs Vercel
- Consid√©rer l'ajout d'un syst√®me de retry pour les √©checs temporaires

--------------------------------------------------------------------------------

üîÑ √âVOLUTION FUTURE (SI BESOIN D'UN SERVEUR MCP)
================================================================================

Si vous souhaitez vraiment utiliser un serveur MCP s√©par√© √† l'avenir :

1. Cr√©er le serveur MCP dans mcp/slack-server/
2. D√©ployer le serveur sur un service s√©par√© (Railway, Render, etc.)
3. Modifier lib/slack.ts pour appeler le serveur MCP via JSON-RPC
4. Configurer MCP_SERVER_URL dans les variables d'environnement

Mais pour l'instant, l'approche directe est plus simple et suffisante.

--------------------------------------------------------------------------------

üìö RESSOURCES
================================================================================

- Documentation Slack Incoming Webhooks :
  https://api.slack.com/messaging/webhooks

- Documentation Next.js API Routes :
  https://nextjs.org/docs/app/building-your-application/routing/route-handlers

- Documentation MCP (si besoin) :
  https://modelcontextprotocol.io/

- Documentation Firebase Admin SDK :
  https://firebase.google.com/docs/admin/setup

--------------------------------------------------------------------------------

Derni√®re mise √† jour : 2025-01-15
Auteur : Documentation technique IMREP/Allianz

================================================================================

